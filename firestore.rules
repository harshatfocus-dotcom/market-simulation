rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users can read/write their own user doc
    match /users/{userId} {
      allow read: if request.auth.uid == userId || request.auth.uid != null;
      allow write: if request.auth.uid == userId;
    }

    // Trades are immutable and logged
    match /trades/{tradeId} {
      allow read: if request.auth.uid != null;
      allow create: if request.auth.uid == request.resource.data.userId &&
                       request.resource.data.userId != null &&
                       request.resource.data.timestamp != null &&
                       request.resource.data.symbol != null &&
                       request.resource.data.quantity > 0 &&
                       request.resource.data.price > 0;
      allow update, delete: if false; // Trades are immutable
    }

    // News is public read, only controller can write
    match /news/{newsId} {
      allow read: if request.auth.uid != null;
      allow create: if isController();
      allow update: if isController() && onlyDecayUpdates(resource, request.resource);
      allow delete: if isController();
    }

    // Sessions - only controller can write
    match /sessions/{sessionId} {
      allow read: if request.auth.uid != null;
      allow create: if canClaimController();
      allow update: if isController() || onlyHeartbeat();
      allow delete: if false;
    }

    // Price history - logged by functions
    match /price_history/{docId} {
      allow read: if request.auth.uid != null;
      allow create: if isFunction();
      allow delete: if false;
    }

    // Market state - controller only
    match /artifacts/{appId}/public/data/market_state/{document=**} {
      allow read: if request.auth.uid != null;
      allow write: if isController() || isFunction();
    }

    // Helper functions
    function isFunction() {
      return request.auth.token.firebase.identities.size() == 0;
    }

    function isController() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isController == true;
    }

    function canClaimController() {
      let activeSession = exists(/databases/$(database)/documents/sessions) &&
        get(/databases/$(database)/documents/sessions).data.active != true;
      return activeSession || request.auth.uid != null;
    }

    function onlyHeartbeat() {
      return request.resource.data.lastHeartbeat != resource.data.lastHeartbeat &&
             request.resource.data.keys() == resource.data.keys();
    }

    function onlyDecayUpdates(oldData, newData) {
      return oldData.diff(newData).affectedKeys().hasOnly(['decay', 'archived']);
    }
  }
}
